name: supabase-ci
on:
  push:
    branches: [ "main", "master" ]
    paths:
      - "supabase/**"
      - ".github/workflows/supabase-ci.yml"
  pull_request:
    branches: [ "main", "master" ]
    paths:
      - "supabase/**"
      - ".github/workflows/supabase-ci.yml"
jobs:
  validate-migrations:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v2
      - name: Show CLI version
        run: supabase --version
      - name: List migrations
        run: ls -la supabase/migrations || true
      - name: Link project (optional)
        if: ${{ secrets.SUPABASE_ACCESS_TOKEN != '' && secrets.SUPABASE_PROJECT_REF != '' }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }} || true
      - name: Dry-run push migrations if linked
        if: ${{ secrets.SUPABASE_ACCESS_TOKEN != '' && secrets.SUPABASE_PROJECT_REF != '' }}
        run: supabase db push --dry-run || true
